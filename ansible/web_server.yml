- name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ nginx
  hosts: webservers
  become: yes

  tasks:
    - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å nginx
      ansible.builtin.apt:
        name: nginx
        state: present
        update_cache: yes

    - name: –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /var/www/html —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      ansible.builtin.file:
        path: /var/www/html
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: –ü–æ–ª–æ–∂–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π index.html (—Å hostname)
      ansible.builtin.copy:
        dest: /var/www/html/index.html
        owner: www-data
        group: www-data
        mode: '0644'
        content: |
          <!doctype html>
          <html>
          <head><meta charset="utf-8"><title>My Site</title></head>
          <body style="font-family: sans-serif">
            <h1>It works üéâ</h1>
            <p>Served by: <b>{{ ansible_hostname }}</b></p>
          </body>
          </html>

    - name: –£–¥–∞–ª–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É Debian (–µ—Å–ª–∏ –µ—Å—Ç—å)
      ansible.builtin.file:
        path: /var/www/html/index.nginx-debian.html
        state: absent

    # === –°–Ω–∏–ø–ø–µ—Ç —Å–æ stub_status ===
    - name: –°–æ–∑–¥–∞—Ç—å snippet nginx_status.conf
      ansible.builtin.copy:
        dest: /etc/nginx/snippets/nginx_status.conf
        owner: root
        group: root
        mode: '0644'
        content: |
          location /nginx_status {
              stub_status on;
              # –†–∞–∑—Ä–µ—à–∞–µ–º —Å localhost –∏ –≤—Å–µ–π VPC
              allow 127.0.0.1;
              allow 10.0.0.0/8;
              deny all;
          }
      notify: Reload nginx

    # –í–∫–ª—é—á–∞–µ–º snippet –≤–Ω—É—Ç—Ä–∏ –ø–µ—Ä–≤–æ–≥–æ server{} default-—Å–∞–π—Ç–∞
    - name: –ü–æ–¥–∫–ª—é—á–∏—Ç—å snippet –≤ default server{}
      ansible.builtin.blockinfile:
        path: /etc/nginx/sites-available/default
        marker: "# {mark} managed by ansible (include nginx_status)"
        insertbefore: '^\s*}\s*$'   # –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã–≤–∞—é—â–µ–π } —Å–µ—Ä–≤–µ—Ä–∞
        block: |
          include snippets/nginx_status.conf;
      notify: Reload nginx

    - name: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ nginx
      ansible.builtin.command: nginx -t
      register: nginx_test
      changed_when: false
      failed_when: nginx_test.rc != 0

  handlers:
    - name: Reload nginx
      ansible.builtin.systemd:
        name: nginx
        state: reloaded
        enabled: yes
