- name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ nginx
  hosts: webservers
  become: yes

  tasks:
    - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å nginx
      ansible.builtin.apt:
        name: nginx
        state: present
        update_cache: yes
 
    - name: –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /var/www/html —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      ansible.builtin.file:
        path: /var/www/html
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: –ü–æ–ª–æ–∂–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π index.html (—Å hostname)
      ansible.builtin.copy:
        dest: /var/www/html/index.html
        owner: www-data
        group: www-data
        mode: '0644'
        content: |
          <!doctype html>
          <html>
          <head><meta charset="utf-8"><title>My Site</title></head>
          <body style="font-family: sans-serif">
            <h1>It works üéâ</h1>
            <p>Served by: <b>{{ ansible_hostname }}</b></p>
          </body>
          </html>

    - name: –£–¥–∞–ª–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É Debian (–µ—Å–ª–∏ –µ—Å—Ç—å)
      ansible.builtin.file:
        path: /var/www/html/index.nginx-debian.html
        state: absent

    # === –í–ö–õ–Æ–ß–ê–ï–ú stub_status ===
    - name: –í–∫–ª—é—á–∏—Ç—å stub_status –≤ Nginx (–ª–æ–∫–∞—Ü–∏—è /nginx_status)
      ansible.builtin.blockinfile:
        path: /etc/nginx/sites-available/default
        marker: "# {mark} managed by ansible (stub_status)"
        insertafter: '^\s*server\s*\{'
        block: |
          location /nginx_status {
              stub_status on;
              allow 10.0.0.0/8;
              deny all;
          }
      notify: Restart nginx

  handlers:
    - name: Restart nginx
      ansible.builtin.systemd:
        name: nginx 
        state: restarted
        enabled: yes
