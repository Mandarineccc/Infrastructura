- name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ nginx
  hosts: webservers
  become: yes

  tasks:
    - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å nginx
      ansible.builtin.apt:
        name: nginx
        state: present
        update_cache: yes

    - name: –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /var/www/html —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      ansible.builtin.file:
        path: /var/www/html
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: –ü–æ–ª–æ–∂–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π index.html (—Å hostname)
      ansible.builtin.copy:
        dest: /var/www/html/index.html
        owner: www-data
        group: www-data
        mode: '0644'
        content: |
          <!doctype html>
          <html>
          <head><meta charset="utf-8"><title>My Site</title></head>
          <body style="font-family: sans-serif">
            <h1>It works üéâ</h1>
            <p>Served by: <b>{{ ansible_hostname }}</b></p>
          </body>
          </html>

    - name: –£–¥–∞–ª–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É Debian (–µ—Å–ª–∏ –µ—Å—Ç—å)
      ansible.builtin.file:
        path: /var/www/html/index.nginx-debian.html
        state: absent

        # 1) –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π inline-–±–ª–æ–∫, –µ—Å–ª–∏ –±—ã–ª
    - name: Remove old inline stub_status block (if present)
      ansible.builtin.blockinfile:
        path: /etc/nginx/sites-available/default
        marker: "# {mark} managed by ansible (stub_status)"
        state: absent
      notify: Reload nginx

    # 2) –°–æ–∑–¥–∞—ë–º —Å–Ω–∏–ø–ø–µ—Ç —Å /nginx_status
    - name: Create snippet nginx_status.conf
      ansible.builtin.copy:
        dest: /etc/nginx/snippets/nginx_status.conf
        owner: root
        group: root
        mode: '0644'
        content: |
          location /nginx_status {
              stub_status on; 
              allow 127.0.0.1;
              allow 10.0.0.0/8;
              deny all;
          }
      notify: Reload nginx

    # 3) –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—É—é include-—Å—Ç—Ä–æ–∫—É –≤–Ω—É—Ç—Ä–∏ server{}
    - name: Include snippet inside default server{}
      ansible.builtin.lineinfile:
        path: /etc/nginx/sites-available/default
        regexp: '^\s*include\s+snippets/nginx_status\.conf;'
        line: '    include snippets/nginx_status.conf;'
        insertafter: '^\s*server\s*\{'
      notify: Reload nginx

    # 4) –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥
    - name: Test nginx config
      ansible.builtin.command: nginx -t
      register: nginx_test
      changed_when: false
      failed_when: nginx_test.rc != 0

  handlers:
    - name: Reload nginx
      ansible.builtin.systemd:
        name: nginx
        state: reloaded
        enabled: yes
